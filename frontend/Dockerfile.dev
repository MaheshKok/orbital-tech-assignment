# Development Dockerfile for React + Vite frontend with hot reload
FROM node:22.12-bookworm-slim

WORKDIR /app

# Install Bun (used for dependency installation)
RUN npm i -g bun@1.1.45

# Install dependencies first (for better caching)
COPY package*.json ./
RUN bun install --no-save

# Bun doesn't currently install Rollup's platform-native optional dependency.
# Ensure the correct `@rollup/rollup-linux-*` package is present for Vite.
RUN node - <<'NODE'
const fs = require("fs");
const { execSync } = require("child_process");

if (process.platform !== "linux") process.exit(0);

const rollupPkg = JSON.parse(
	fs.readFileSync("node_modules/rollup/package.json", "utf8")
);
const rollupVersion = rollupPkg.version;

const archMap = { x64: "x64", arm64: "arm64" };
const arch = archMap[process.arch];
if (!arch) process.exit(0);

let isMusl = false;
try {
	const out = execSync("ldd --version 2>&1 || true", { encoding: "utf8" });
	isMusl = out.toLowerCase().includes("musl");
} catch {}

const libc = isMusl ? "musl" : "gnu";
const pkg = `@rollup/rollup-linux-${arch}-${libc}`;

execSync(`bun add --no-save ${pkg}@${rollupVersion}`, { stdio: "inherit" });
NODE

# Don't copy source - it will be mounted as a volume

# Expose Vite dev server port
EXPOSE 5173

# Start Vite dev server with host binding for Docker
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
